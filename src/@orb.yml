version: 2.1

description: Run PHPUnit tests

display:
    home_url: "https://stockfiller.com"
    source_url: "https://github.com/stockfiller/phpunit-orb"

orbs:
    composer: stockfiller/composer@0.0.31

executors:
    default:
        docker:
            -   image: cimg/php:7.4
        resource_class: small

jobs:
    test:
        parameters:
            executor:
                type: executor
                default: default
                description: Environment to run the tests inside
            path:
                type: string
                default: vendor/bin/phpunit
                description: Path to the PHPUnit executable inside the environment. Defaults to locally installed PHPUnit inside repository.
            flags:
                type: string
                description: Optional PHPUnit flags to append to the test command
                default: ""
            configuration:
                type: string
                description: Optional PHPUnit configuration path
                default: ""
            testsuite:
                type: string
                description: Optional PHPUnit testsuite
                default: ""
        executor: << parameters.executor >>
        steps:
            - checkout
            - composer/install
            -   run:
                    name: Run PHPUnit tests
                    environment:
                        PHPUNIT_FLAGS: >-
                            <<# parameters.configuration >> --configuration << parameters.configuration >> <</ parameters.configuration >>
                            <<# parameters.testsuite >> --testsuite << parameters.testsuite >> <</ parameters.testsuite >>
                            << parameters.flags >>
                    command: << parameters.path >> --log-junit test-results/tests.xml --do-not-cache-result ${PHPUNIT_FLAGS}
            -   store_test_results:
                    path: test-results
            -   store_artifacts:
                    path: test-results
